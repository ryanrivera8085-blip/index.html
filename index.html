<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Luminu 3D</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin:0;
  overflow:hidden;
  background:black;
  font-family:Arial;
}

/* UI */
#ui {
  position:absolute;
  left:10px;
  bottom:10px;
  z-index:10;
}

#joystick {
  width:90px;
  height:90px;
  border-radius:50%;
  background:rgba(255,255,255,0.15);
  margin-bottom:6px;
}

.btn {
  width:90px;
  padding:6px;
  margin-top:4px;
  font-size:12px;
  border-radius:8px;
  border:none;
  background:#00cfd1;
  color:black;
}

#bossBar {
  position:absolute;
  top:15px;
  left:50%;
  transform:translateX(-50%);
  width:200px;
  height:10px;
  background:#400;
  display:none;
}
#bossLife {
  height:100%;
  width:100%;
  background:red;
}
</style>
</head>

<body>

<!-- UI -->
<div id="ui">
  <div id="joystick"></div>
  <button class="btn" id="pulseBtn">PULSO</button>
  <button class="btn" id="shieldBtn">ESCUDO</button>
  <button class="btn" id="shopBtn">TIENDA</button>
</div>

<div id="bossBar"><div id="bossLife"></div></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>

<script>
/* ===== ESCENA ===== */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);

const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 200);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 1));

/* ===== SUELO ===== */
const floor = new THREE.Mesh(
  new THREE.PlaneGeometry(300,300),
  new THREE.MeshBasicMaterial({color:0x111111})
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/* ===== STICKMAN (ANIMADO) ===== */
const player = new THREE.Group();

// cuerpo
const body = new THREE.Mesh(
  new THREE.BoxGeometry(0.6,1.4,0.4),
  new THREE.MeshBasicMaterial({color:0xffffff})
);
body.position.y = 0.7;
player.add(body);

// cabeza
const head = new THREE.Mesh(
  new THREE.SphereGeometry(0.35,16,16),
  new THREE.MeshBasicMaterial({color:0xffffff})
);
head.position.y = 1.6;
player.add(head);

// piernas
const legL = new THREE.Mesh(
  new THREE.BoxGeometry(0.2,0.7,0.2),
  new THREE.MeshBasicMaterial({color:0xffffff})
);
legL.position.set(-0.15,0.35,0);
player.add(legL);

const legR = legL.clone();
legR.position.x = 0.15;
player.add(legR);

scene.add(player);

/* ===== VARIABLES ===== */
let moveX=0, moveY=0;
let zombies=[];
let kills=0;
let boss=null;
let pulseReady=true;
let shieldLife=0;

// cámara
let camAngle = 0;
let camDistance = 7;
let camHeight = 4;

/* ===== JOYSTICK ===== */
const joystick = document.getElementById("joystick");
joystick.addEventListener("touchmove", e=>{
  const t=e.touches[0];
  const r=joystick.getBoundingClientRect();
  moveX=(t.clientX-(r.left+r.width/2))/40;
  moveY=(t.clientY-(r.top+r.height/2))/40;
  moveX=Math.max(-1,Math.min(1,moveX));
  moveY=Math.max(-1,Math.min(1,moveY));
});
joystick.addEventListener("touchend",()=>{moveX=moveY=0;});

/* ===== CÁMARA CON DEDO ===== */
let touchingCamera = false;
let lastX = 0;

addEventListener("touchstart", e=>{
  if(e.touches[0].clientX > innerWidth/2){
    touchingCamera = true;
    lastX = e.touches[0].clientX;
  }
});

addEventListener("touchmove", e=>{
  if(!touchingCamera) return;
  const x = e.touches[0].clientX;
  camAngle += (x - lastX) * 0.005;
  lastX = x;
});

addEventListener("touchend", ()=> touchingCamera=false);

/* ===== ZOMBIES ===== */
function spawnZombie(){
  kills++;
  let type="normal";
  if(kills%15===0) type="boss";
  else if(kills%10===0) type="red";

  if(type==="boss"){
    boss=new THREE.Mesh(
      new THREE.BoxGeometry(3,4,3),
      new THREE.MeshBasicMaterial({color:0x880088})
    );
    boss.position.set(Math.random()*10-5,2,-20);
    boss.hp=10;
    scene.add(boss);
    bossBar.style.display="block";
    bossLife.style.width="100%";
    return;
  }

  const z=new THREE.Mesh(
    new THREE.BoxGeometry(0.8,1.6,0.6),
    new THREE.MeshBasicMaterial({color:type==="red"?0xff0000:0x00ff00})
  );
  z.position.set(Math.random()*12-6,0.8,-20);
  z.hp=type==="red"?2:1;
  z.speed=type==="red"?0.07:0.045;
  z.damage=type==="red"?3:1;
  scene.add(z);
  zombies.push(z);
}
setInterval(spawnZombie,1500);

/* ===== PULSO ===== */
pulseBtn.onclick=()=>{
  if(!pulseReady) return;
  pulseReady=false;

  zombies=zombies.filter(z=>{
    if(z.position.distanceTo(player.position)<5){
      z.hp--;
      if(z.hp<=0){scene.remove(z); return false;}
    }
    return true;
  });

  if(boss && boss.position.distanceTo(player.position)<6){
    boss.hp--;
    bossLife.style.width=(boss.hp/10*100)+"%";
    if(boss.hp<=0){
      scene.remove(boss);
      boss=null;
      bossBar.style.display="none";
    }
  }

  setTimeout(()=>pulseReady=true,5000);
};

/* ===== ESCUDO ===== */
shieldBtn.onclick=()=>{
  shieldLife=5;
};

/* ===== LOOP ===== */
let walkTime = 0;

function animate(){
  requestAnimationFrame(animate);

  // movimiento
  player.position.x+=moveX*0.12;
  player.position.z+=moveY*0.12;

  // animación piernas
  if(moveX!==0 || moveY!==0){
    walkTime+=0.15;
    legL.rotation.x=Math.sin(walkTime)*0.8;
    legR.rotation.x=-Math.sin(walkTime)*0.8;
  } else {
    legL.rotation.x=legR.rotation.x=0;
  }

  // zombies persiguen
  zombies.forEach(z=>{
    z.lookAt(player.position);
    z.translateZ(z.speed);
    if(z.position.distanceTo(player.position)<1){
      if(shieldLife>0) shieldLife-=z.damage;
    }
  });

  if(boss){
    boss.lookAt(player.position);
    boss.translateZ(0.02);
  }

  // cámara
  camera.position.x = player.position.x + Math.sin(camAngle)*camDistance;
  camera.position.z = player.position.z + Math.cos(camAngle)*camDistance;
  camera.position.y = camHeight;
  camera.lookAt(player.position);

  renderer.render(scene,camera);
}
animate();

addEventListener("resize",()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>

</body>
</html>
